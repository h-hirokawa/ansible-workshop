# 演習3 - ジョブテンプレートの作成と実行

[前に戻る](./ex2.html)

------

ジョブテンプレートは、Ansible Towerのジョブを実行するための定義セットであり、インベントリー（どこにデプロイするか）、playbook（何をデプロイするか）と認証情報や各種playbook実行時パラメータを固めて保存したものとなります。
ジョブテンプレートを使うことで、同じジョブを同一の情報で何度も繰り返し実行することが可能となります。

## ジョブテンプレートの作成

### Step 1:

画面左の一覧から「テンプレート」をクリックします。

### Step 2:

「+」（新規追加ボタン）をクリックし、「ジョブテンプレート」を選択

### Step 3:

以下の値で、新規ジョブテンプレートを作成します。

| 項目           | 値                             |
| -------------- | ------------------------------ |
| 名前           | Apache Basicジョブテンプレート |
| ジョブタイプ   | 実行                           |
| インベントリー | トレーニング用インベントリー   |
| プロジェクト   | トレーニング用プロジェクト     |
| PLAYBOOK       | apache-basic-playbook/site.yml |
| 認証情報       | トレーニング用マシン認証情報   |

OPTIONS(オプション)

- [x] ファクトのキャッシュの使用

---

Note:

* ファクトのキャッシュを有効化することで、Ansible Towerに操作対象ホストの内部状態(Facts)を保存することが可能となります。
* 各パラメータの「起動プロンプト」にチェックを入れると、ジョブテンプレート実行時に動的に値を渡せるようになります。例えば「詳細」の起動プロンプトを有効にすると、手軽にログレベルをあげてジョブテンプレートを実行できるようになりますので、検証/デバッグ時には便利です。

### Step 4:

「保存」をクリックします。 

## ジョブテンプレートの実行

ここまででジョブテンプレートの作成が完了し、Towerからplaybookを実行できる状態になりました。ジョブテンプレートを実行すると、リアルタイムでジョブ実行ステータスを表示するジョブ・スクリーンへリダイレクトされます。

### Step 1:

画面左の一覧から「テンプレート」をクリックします。

### Step 2:

「Apache Basicジョブテンプレート」の横にあるロケットのアイコン をクリックしてジョブを実行しましょう。
今回は起動プロンプトなどは何も設定されていないため、アイコンをクリックするとジョブテンプレートが即時実行されます。

### Step 3:

自動で遷移されるジョブ実行ステーラス画面で、playbookが問題なく実行されていることを確認しましょう。

ログ左側のウィンドウには実行されているジョブのサマリーが表示されます。

ここには、このジョブが、いつ/誰によって/どのプレイブックが/どのバージョンで/どのインベントリーに対して/どの認証情報で実行されているのか？ということが記載されています。
単純にplaybook実行ログだけではなく、このような情報が残されていることによって、Towerからは過去のジョブがどのような状態で実行されたのかが詳細に追えるようになっています。

### Step 4:

ジョブが問題なく完了したなら、ブラウザから管理対象ノードのIPアドレスにアクセスして、Towerからデプロイされた新しいWebサイトを見てみましょう。
ホスト変数で指定した「このホストはTowerからデプロイしました」というメッセージが表示されていれば、問題なくTowerからのデプロイが実行できています。

## キャッシュされたファクトの確認

「ファクトのキャッシュの使用」を有効化したテンプレートからジョブを実行すると、ホストのファクト情報がTowerに保存されているはずです。実際に保存されているか確認してみましょう。

### Step 1:

画面左の一覧から「インベントリー」をクリックします。

### Step 2:

インベントリーの中から「トレーニング用インベントリー」を選択します。

### Step 3:

インベントリー詳細画面中の「ホスト」タブをクリックします。

### Step 4:

ホスト一覧から「node1」を選択します。

### Step 5:

「ファクト」タブをクリックして、実際にファクト情報が保存されているか確認しましょう。

なお、ファクトはキャッシュが有効になっているジョブテンプレートが実行されるたびに更新されます。保存日時についてはファクト内の `ansible_date_time` で確認することが可能です。

## ジョブテンプレートにSURVEYを追加

Ansible Towerでは「起動プロンプト」の設定以外に、実行時パラメータとして変数情報を渡せるようにSURVEYという機能が用意されています。

実行時の変数定義を行うにはジョブテンプレートの「追加変数」を「起動プロンプト」に指定する方法もありますが、この場合、playbook中のあらゆる変数を実行時に書き換え可能になってしまいます。
一方、SURVEYを使うと、特定の変数の値だけをパラメータできるようになるため、管理された範囲でのみ実行時の変数設定を許可することが可能になります。

### Step 1:

画面左の一覧から「テンプレート」をクリックします。

### Step 2:

テンプレートの中から「Apache Basicジョブテンプレート」を選択します。

### Step 3:

テンプレート設定ウィンドウ上部、一番右にある「SURVEYの追加」をクリックします。 

### Step 4:

下記の値でSURVEY機能で取り込みたい値のフォームを作成します。

ここでは、`apache_test_message` 変数をSURVEYから設定可能にしましょう。

項目 | 値
------|------------------------------------------------
プロンプト| ウェブサイトに表示されるテストメッセージ 
回答の変数名|apache_test_message
回答タイプ|Text
|デフォルトのテストメッセージ

- [ ] 必須 (チェックを外す)


### Step 5:

「+ ADD」をクリックします。

### Step 6:

プレビューにプロンプト内容が表示されていることを確認して、「保存」をクリックします。
（プレビュー表示中でDEFAULT ANSWERが文字化けすることがありますが、実害はないのでそのまま進んでください）

## SURVEY付きジョブテンプレートの実行

それでは、SURVEY付きでジョブテンプレートを実行してみましょう。

### Step 1:

画面左の一覧から「テンプレート」をクリックします。

### Step 2:

「Apache Basicジョブテンプレート」の横にあるロケットのアイコン をクリックします。

### Step 3:

先ほどSurveyで作成したプロンプトが出現するはずですので、以下のようなテキストを入力して「次へ」をクリックしましょう。

**SURVEYから動的に設定したメッセージです**

### Step 4:

設定した値が `apache_test_message` に定義されていることを確認して「起動」をクリックしましょう。

### Step 5:

ジョブ実行が完了するのを待ち、ブラウザから管理対象ノードにアクセスして、「**SURVEYから動的に設定したメッセージです**」というメッセージが表示されていることを確認しましょう。

---

Note:
SURVEYである変数を動的に設定できるようにした場合、インベントリーやplaybook/role中で設定した変数値は全てSURVEY側の値によって上書きされることに気をつけてください。
今回はトレーニング用にHTML上のメッセージをSURVEYから変更していますが、インフラCIの観点からは**インフラの設定が全てソースコードとして管理されていること**が重要ですので、実運用の際には**設定を更新するような変数はInventory側の変数として管理**し、SURVEYは例えばプロセスの起動管理やの状態確認系タスクなど、設定を変更しない運用タスクに活用するのが良いでしょう。

---

[次に進む](./ex4.html)